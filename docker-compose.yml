version: "3.8"

# ═══════════════════════════════════════════════════════════════════════
# MEDIA SERVER STACK - LOCAL ACCESS ONLY
# All torrent traffic MUST go through VPN - zero tolerance for leaks
# ═══════════════════════════════════════════════════════════════════════

networks:
  media_network:
    driver: bridge
    internal: false  # Jellyfin needs internet for metadata

services:
  # ═══════════════════════════════════════════════════════════════════════
  # GLUETUN VPN - Mullvad WireGuard with kill switch
  # All qBittorrent traffic routes through this container
  # ═══════════════════════════════════════════════════════════════════════
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${QBITTORRENT_PORT}:8080"           # qBittorrent WebUI
      - "${GLUETUN_CONTROL_PORT}:8000"       # Gluetun control server
      - "6881:6881"                           # qBittorrent incoming
      - "6881:6881/udp"
    volumes:
      - ${CONFIG_ROOT}/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_CITIES=${VPN_SERVER_CITIES}
      - FIREWALL_OUTBOUND_SUBNETS=${LAN_SUBNET}
      - TZ=${TZ}
      - HEALTH_VPN_DURATION_INITIAL=30s
      - HTTPPROXY=on
      - HTTPPROXY_LOG=on
    networks:
      - media_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "https://am.i.mullvad.net/connected"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # ═══════════════════════════════════════════════════════════════════════
  # QBITTORRENT - Torrent client (VPN PROTECTED)
  # network_mode forces ALL traffic through Gluetun VPN
  # ═══════════════════════════════════════════════════════════════════════
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8080
    volumes:
      - ${CONFIG_ROOT}/qbittorrent:/config
      - ${DATA_ROOT}/torrents:/data/torrents
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    labels:
      - "autoheal=true"

  # ═══════════════════════════════════════════════════════════════════════
  # AUTOHEAL - Restarts unhealthy containers
  # Critical: qBittorrent loses network when Gluetun restarts
  # ═══════════════════════════════════════════════════════════════════════
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    network_mode: none
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=60
      - DOCKER_SOCK=/var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════
  # JELLYFIN - Media server
  # ═══════════════════════════════════════════════════════════════════════
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    user: "${PUID}:${PGID}"
    group_add:
      - "${RENDER_GID}"
    environment:
      - TZ=${TZ}
      - JELLYFIN_PublishedServerUrl=http://${LAN_SUBNET%/*}:${JELLYFIN_PORT}
    volumes:
      - ${CONFIG_ROOT}/jellyfin/config:/config
      - ${CONFIG_ROOT}/jellyfin/cache:/cache
      - ${DATA_ROOT}/media:/media:ro
    devices:
      - /dev/dri/renderD128:/dev/dri/renderD128
      - /dev/dri/card0:/dev/dri/card0
    tmpfs:
      - /config/transcodes:size=8G
    ports:
      - "${JELLYFIN_PORT}:8096"
      - "${JELLYFIN_DISCOVERY_PORT}:7359/udp"
    networks:
      - media_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════
  # JELLYSEERR - Content request management
  # ═══════════════════════════════════════════════════════════════════════
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    init: true
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
    volumes:
      - ${CONFIG_ROOT}/jellyseerr:/app/config
    ports:
      - "${JELLYSEERR_PORT}:5055"
    networks:
      - media_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ═══════════════════════════════════════════════════════════════════════
  # RADARR - Movie automation
  # ═══════════════════════════════════════════════════════════════════════
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/radarr:/config
      - ${DATA_ROOT}:/data
    ports:
      - "${RADARR_PORT}:7878"
    networks:
      - media_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════
  # SONARR - TV show automation
  # ═══════════════════════════════════════════════════════════════════════
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/sonarr:/config
      - ${DATA_ROOT}:/data
    ports:
      - "${SONARR_PORT}:8989"
    networks:
      - media_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════
  # PROWLARR - Indexer manager
  # ═══════════════════════════════════════════════════════════════════════
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/prowlarr:/config
    ports:
      - "${PROWLARR_PORT}:9696"
    networks:
      - media_network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════════════
  # BAZARR - Subtitle automation
  # ═══════════════════════════════════════════════════════════════════════
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG_ROOT}/bazarr:/config
      - ${DATA_ROOT}/media:/data/media
    ports:
      - "${BAZARR_PORT}:6767"
    networks:
      - media_network
    restart: unless-stopped
